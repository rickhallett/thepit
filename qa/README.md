# QA Automation Framework

Automated QA testing for THE PIT, enabling LLM-driven test execution.

## Overview

This framework parses user stories from `docs/qa-report.md` and provides infrastructure for automated testing using:

- **Playwright MCP** for browser-based UI testing
- **API calls** (fetch/curl) for endpoint testing
- **Database queries** for state verification

## Quick Start

```bash
# Install dependencies (includes tsx)
pnpm install

# Set up test accounts (first time only)
pnpm run qa:setup

# Dry run - see what tests would execute
pnpm run qa:dry

# Run all implemented tests
pnpm run qa

# Run specific categories
pnpm run qa:nav      # Navigation tests
pnpm run qa:auth     # Authentication tests
pnpm run qa:arena    # Arena page tests

# Run by automation tier
pnpm run qa:api      # API-only tests
pnpm run qa:browser  # Browser-based tests

# Run specific test(s)
pnpm run qa:single NAV-001
pnpm run qa:single NAV-001 NAV-002 NAV-003
```

## Configuration

### 1. Set Up Test Accounts

Test accounts are created in Clerk and the local database using the setup script:

```bash
# Ensure CLERK_SECRET_KEY and DATABASE_URL are set in .env
# Use a DEVELOPMENT Clerk instance (sk_test_* key)

# Required: set the test account password from your secrets manager
export QA_TEST_PASSWORD="<password from team vault or secrets manager>"

# Create test accounts
pnpm run qa:setup
```

This creates three test accounts:

| Account | Email | Tier | Credits |
|---------|-------|------|---------|
| `standard` | qa-standard@thepit.cloud | free | 500 |
| `premium` | qa-premium@thepit.cloud | pit_pass | 1000 |
| `exhausted` | qa-exhausted@thepit.cloud | free | 0 |

After setup, copy the output to your `.env.test` file.

### 2. Configure .env.test

Copy `.env.test.example` to `.env.test` and fill in the generated values:

```bash
# Base URL for testing
QA_BASE_URL=http://localhost:3000

# Database connection (QA_DATABASE_URL preferred, falls back to DATABASE_URL)
QA_DATABASE_URL=postgresql://...

# Shared password for test accounts (retrieve from secrets manager)
QA_TEST_PASSWORD=<password from team vault or secrets manager>

# Test accounts (generated by pnpm run qa:setup)
QA_TEST_USER_EMAIL=qa-standard@thepit.cloud
QA_TEST_USER_ID=user_2abc...

QA_PREMIUM_USER_EMAIL=qa-premium@thepit.cloud
QA_PREMIUM_USER_ID=user_2def...

QA_EXHAUSTED_USER_EMAIL=qa-exhausted@thepit.cloud
QA_EXHAUSTED_USER_ID=user_2ghi...
```

### 3. Teardown (Optional)

To remove test accounts:

```bash
# Preview what will be deleted
pnpm run qa:teardown

# Actually delete (requires confirmation flag)
pnpm run qa:teardown --yes
```

## Directory Structure

```text
qa/
├── README.md               # This file
├── runner.ts               # Main test runner CLI
├── parser.ts               # QA report markdown parser
├── writer.ts               # Results writer (updates qa-report.md)
├── config.ts               # Configuration loader
├── tiers.ts                # Automation tier mappings
├── fixtures/
│   ├── accounts.ts         # Test account definitions
│   └── seeds.ts            # Database seed helpers
├── scripts/
│   ├── setup-accounts.ts   # Creates test accounts in Clerk + DB
│   └── teardown-accounts.ts # Removes test accounts
├── tests/                  # Test implementations (to be added)
├── utils/                  # Shared utilities (to be added)
└── results/                # Test run artifacts
```

## Test Report Format

Tests are defined in `docs/qa-report.md` using this format:

```markdown
- [ ] `[qa:_][func:_][broken:_]` **NAV-001**: As a user, I can see the logo
  - Expected: Logo visible in header, clicking navigates to `/`
```

Status flags:
- `qa:x` = tested, `qa:_` = not tested
- `func:x` = working, `func:_` = not verified
- `broken:x` = broken, `broken:_` = not broken

## Automation Tiers

Each test is classified by automation feasibility:

| Tier | Description | Count |
|------|-------------|-------|
| `api` | HTTP/curl/database tests | 30 |
| `browser` | Playwright UI tests | 125 |
| `partial` | Needs specific setup | 21 |
| `human` | Cannot automate | 6 |

Human-required tests (payment flows, OAuth) are skipped automatically.

## Adding Tests

1. Create test implementation in `qa/tests/{category}.ts`
2. Register with the test runner

```typescript
// qa/tests/navigation.ts
import { registerTest, type TestImplementation } from '../runner.js'

const NAV_001: TestImplementation = {
  id: 'NAV-001',
  tier: 'browser',
  async run(ctx) {
    // Navigate and verify
    await ctx.browser.navigate('/')
    const snapshot = await ctx.browser.snapshot()

    const logo = snapshot.findByRole('link', { name: /the pit/i })
    if (!logo) {
      return { passed: false, error: 'Logo not found' }
    }

    return { passed: true, evidence: 'Logo visible and links to home' }
  }
}

// Register the test
registerTest(NAV_001)
```

## Results

After running tests:
- `docs/qa-report.md` is updated with test results
- Console shows pass/fail summary
- `qa/results/` contains run artifacts

## Human Testing Checklist

These 7 tests require manual verification:

- [ ] AUTH-004: Google OAuth flow
- [ ] CREDIT-006: Purchase Starter pack (real Stripe)
- [ ] CREDIT-007: Purchase Plus pack (real Stripe)
- [ ] CREDIT-013: Subscribe to Pit Pass
- [ ] CREDIT-014: Subscribe to Pit Lab
- [ ] CREDIT-016: Failed payment downgrade
- [ ] CREDIT-017: Subscription cancellation

Use Stripe test mode with card `4242 4242 4242 4242`.

## CI Integration

Add to GitHub Actions:

```yaml
- name: Run QA tests
  run: pnpm run qa:api
  env:
    QA_BASE_URL: ${{ secrets.STAGING_URL }}
    QA_DATABASE_URL: ${{ secrets.QA_DATABASE_URL }}
```

Note: Use `QA_DATABASE_URL` to explicitly target the test database.
