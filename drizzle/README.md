[← Root](../README.md)

# drizzle/

SQL migration files generated by `drizzle-kit` and their metadata snapshots. Migrations are forward-only (no down migrations) and use idempotent guards (`IF NOT EXISTS`, `IF EXISTS`).

## Migration History

| Index | Tag | Date | Description |
|-------|-----|------|-------------|
| 0000 | `merge_2026_02_08` | Feb 8, 2026 | Initial schema merge: all core tables (`bouts`, `users`, `credits`, `credit_transactions`, `intro_pool`, `referrals`, `reactions`, `winner_votes`, `newsletter_signups`, `agents`) + `bout_status` and `agent_tier` enums |
| 0001 | `subscription-model` | Feb 10, 2026 | Subscription model: `user_tier` enum, `agent_flags` table, `free_bout_pool` table, subscription columns on `users`, `agents.archived` flag, new indexes |
| 0002 | `code-review-hardening` | Feb 11, 2026 | Post-review hardening: `bouts.updated_at`, 7 performance indexes, unique constraint on `newsletter_signups.email`, catches schema drift from ad-hoc changes |

## Structure

```
drizzle/
├── 0000_merge_2026_02_08.sql
├── 0001_subscription-model.sql
├── 0002_code-review-hardening.sql
└── meta/
    ├── _journal.json          Migration journal (version 7)
    ├── 0000_snapshot.json     Schema snapshot after migration 0
    ├── 0001_snapshot.json     Schema snapshot after migration 1
    └── 0002_snapshot.json     Schema snapshot after migration 2
```

## Creating a New Migration

```bash
# 1. Edit db/schema.ts with your changes
# 2. Generate a migration:
npx drizzle-kit generate

# 3. Review the generated SQL in drizzle/
# 4. Apply to your database:
npx drizzle-kit push
```

### Configuration

Drizzle-kit is configured in `drizzle.config.ts`:
- **Schema source:** `./db/schema.ts`
- **Output directory:** `./drizzle/`
- **Dialect:** `postgresql`
- **Strict mode:** enabled (warns on destructive changes)
- **Credentials:** `DATABASE_URL` env var

## Notes

- All migrations use idempotent SQL (`IF NOT EXISTS` / `IF EXISTS`) for safe re-runs
- The `meta/_journal.json` tracks migration ordering and is managed by drizzle-kit — do not edit manually
- Snapshot files in `meta/` capture the full schema state at each migration point for diffing

---

[← Root](../README.md) · [DB](../db/README.md) · [App](../app/README.md)
