#!/usr/bin/env bash
# post-commit hook — auto-updates .keel-state with machine-derivable fields.
#
# Updates: head (git SHA), sd (last SD-NNN from session-decisions.md).
# Preserves: bearing, tempo, register, weave, officer, conn, gate, tests.
# Warns: if bearing has not changed for 5+ commits.
#
# Install:
#   ln -sf ../../scripts/post-commit .git/hooks/post-commit
#
# Uninstall:
#   rm .git/hooks/post-commit

PITKEEL="$(git rev-parse --show-toplevel)/pitkeel/pitkeel"

# Build if needed — silently.
if [ ! -x "$PITKEEL" ]; then
  (cd "$(git rev-parse --show-toplevel)/pitkeel" && go build -o pitkeel . 2>/dev/null)
fi

# If still not available, skip silently — don't block anything.
if [ ! -x "$PITKEEL" ]; then
  exit 0
fi

# Run state-update. Stderr output (staleness warnings) will appear in terminal.
"$PITKEEL" state-update 2>&1

exit 0
