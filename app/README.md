[← Root](../README.md)

# app/

Next.js App Router layer. All routes, layouts, server actions, and API handlers live here. The app uses a flat route structure (no parenthesized route groups) with server components as the default rendering strategy and client components only where interactivity demands it.

## Route Tree

```
app/
├── layout.tsx              Root layout (Clerk, PostHog, AskThePitLazy, header/footer, session init)
├── page.tsx                Landing page
├── global-error.tsx        Global error boundary
├── error.tsx               Root error boundary ('use client')
├── not-found.tsx           Custom 404
├── actions.ts              Server actions (8 exported functions)
├── globals.css             Tailwind v4 entrypoint
├── sitemap.ts              Dynamic sitemap generator
├── robots.ts               Dynamic robots.txt generator
│
├── arena/
│   ├── page.tsx            Preset grid with tier/credits dashboard
│   ├── loading.tsx         Arena loading state
│   └── custom/
│       └── page.tsx        Custom lineup builder (ArenaBuilder component)
│
├── bout/[id]/
│   ├── page.tsx            Live streaming bout (force-dynamic)
│   └── loading.tsx         Bout loading state
│
├── b/[id]/
│   ├── page.tsx            Read-only replay viewer (force-dynamic, generateMetadata for OG tags)
│   └── loading.tsx         Replay loading state
│
├── agents/
│   ├── page.tsx            Agent catalog grid
│   ├── loading.tsx         Agents loading state
│   ├── [id]/page.tsx       Agent detail / DNA page
│   ├── new/page.tsx        Agent builder form
│   └── clone/page.tsx      Clone agent with prefill (?source=...)
│
├── leaderboard/
│   ├── page.tsx            PIT + PLAYER rankings (revalidate=30s)
│   └── loading.tsx         Leaderboard loading state
│
├── feedback/page.tsx       Feature request submission + voting
├── research/
│   ├── page.tsx            Research explainer
│   └── citations/page.tsx  Literature review + paper submission form
├── roadmap/page.tsx        Three-lane public roadmap
├── contact/page.tsx        Contact form ('use client')
├── sign-in/[[...sign-in]]  Clerk catch-all sign-in
├── sign-up/[[...sign-up]]  Clerk catch-all sign-up
├── security/page.tsx       Security policy (static)
├── terms/page.tsx          Terms of service (static)
├── privacy/page.tsx        Privacy policy (static)
├── disclaimer/page.tsx     AI disclaimer (static)
│
├── s/[slug]/route.ts       Short link resolver (302 redirect to /b/:boutId)
├── docs/api/route.ts       Scalar-powered API reference page
│
└── api/                    → See [app/api/README.md](api/README.md)
```

## Dynamic Segments

| Pattern | Route | Purpose |
|---------|-------|---------|
| `[id]` | `/bout/[id]` | Live bout page; `id` is a nanoid generated by `createBout` |
| `[id]` | `/b/[id]` | Replay page; short URL for sharing |
| `[id]` | `/agents/[id]` | Agent detail; `id` is URL-decoded via `decodeAgentId()` |
| `[[...sign-in]]` | `/sign-in/*` | Clerk catch-all (handles multi-step auth flows) |
| `[[...sign-up]]` | `/sign-up/*` | Clerk catch-all for registration |
| `[slug]` | `/s/[slug]` | Short link resolver; 302 redirects to `/b/:boutId` |

## Data Fetching Strategy

**Server components dominate.** Nearly every page is an async Server Component that queries the database directly at render time:

- **`/arena`** — Heavy tier-aware loading: `auth()` + `getUserTier()` + `getCreditBalanceMicro()` + `getCreditTransactions()` + `getIntroPoolStatus()` + `getFreeBoutPoolStatus()` + `getAvailableModels()` + `getFreeBoutsUsed()`
- **`/bout/[id]`** — `auth()` + DB query for bout record + `resolveResponseLength()` + `estimateBoutCostGbp()` + `Promise.all([getReactionCounts, getWinnerVoteCounts, getUserWinnerVote])`. Marked `force-dynamic`.
- **`/b/[id]`** — `auth()` + DB query for bout record + `Promise.all([getReactionCounts, getWinnerVoteCounts, getUserWinnerVote])`. Also `force-dynamic`. Includes `generateMetadata()` for OG/Twitter meta tags (differs from `/bout/[id]` which does not).
- **`/agents`** — `getAgentSnapshots()` loads full agent catalog.
- **`/agents/[id]`** — `Promise.all([getAgentDetail(id, 4), auth(), getRemixStats(id)])` with 4-generation lineage depth and remix statistics.
- **`/leaderboard`** — `getLeaderboardData()` with `revalidate = 30` (ISR, 30-second cache).

**Client components** are used only for: the contact form, the error boundary (required by Next.js), and interactive components imported into server pages (Arena, ArenaBuilder, AgentBuilder, etc.).

### Caching

- Most pages are **dynamically rendered** (no caching).
- Bout pages explicitly use `export const dynamic = 'force-dynamic'`.
- **Leaderboard** is the only route using time-based ISR (`revalidate = 30`).
- Static content pages (terms, privacy, disclaimer, roadmap, research, security) are implicitly statically generated at build time.
- Server actions use `revalidatePath()` for targeted cache invalidation.

## Server Actions (`actions.ts`)

All mutation logic is co-located in a single `'use server'` file:

| Action | Purpose | Auth | Side Effects |
|--------|---------|------|-------------|
| `createBout` | Insert bout, redirect to `/bout/:id` | Required when credits enabled | DB insert, redirect |
| `createArenaBout` | Create custom-lineup bout | Required when credits enabled | DB insert, redirect |
| `createCreditCheckout` | Stripe checkout for credit pack | Required | Stripe session, redirect |
| `createSubscriptionCheckout` | Stripe checkout for subscription | Required | Stripe session, redirect |
| `createBillingPortal` | Stripe billing portal | Required | Stripe session, redirect |
| `grantTestCredits` | Admin: grant test credits | Admin | Credit delta, redirect |
| `archiveAgent` | Admin: soft-delete agent | Admin | DB update, revalidatePath |
| `restoreAgent` | Admin: restore agent | Admin | DB update, revalidatePath |

**Binding pattern:** Actions are bound to forms via native `<form action={...}>` and `action.bind(null, presetId)` for partial application.

## Form Handling Patterns

Three distinct patterns:

1. **Server actions via `<form action>`** — Primary pattern for bout creation, checkout, admin operations. No client JS required for submission.
2. **Client `fetch` to API routes** — Contact form, reactions, winner votes, agent creation.
3. **Client SSE streaming** — The Arena component calls `POST /api/run-bout` and consumes the streaming response via the `useBout` hook.

## Authentication & Authorization

- **Provider:** Clerk (`@clerk/nextjs`). Root layout wraps everything in `<ClerkProvider>`.
- **Session init:** Root layout calls `auth()` + `initializeUserSession()` on every request for authenticated users (handles referral codes, signup bonuses).
- **Per-route auth:** Every server action and API route calls `await auth()` individually. No middleware-level auth gating.
- **Admin checks:** `isAdmin(userId)` for agent archive/restore; seed endpoint uses `x-admin-token` header.
- **Tier system:** Three tiers (`free`, `pass`, `lab`) resolved from Stripe subscription. Controls model access, bout limits, agent slots.

## Observability

- **PostHog:** Root layout wraps content in `<PostHogProvider>` for page view tracking. Only active when `NEXT_PUBLIC_POSTHOG_KEY` is set.
- **Vercel Analytics:** `<Analytics />` component included in root layout.
- **Structured logging:** API routes use `lib/logger.ts` for JSON-structured logs with request IDs.

## Design Decisions & Trade-offs

- **Single server actions file** — All 8 actions in one file centralizes mutation logic but could grow unwieldy as features expand. If action count exceeds ~15, consider splitting by domain (e.g., `actions/bout.ts`, `actions/billing.ts`).
- **Dual bout URLs** — `/bout/[id]` is the live page with `searchParams` for configuration; `/b/[id]` is the clean replay URL. Both render the same `<Arena>` component with different data strategies. The tradeoff is a marginal increase in route surface area for significantly cleaner share URLs.
- **No middleware-level auth** — Authentication is checked per-route rather than in middleware. This is intentional: most pages (landing, legal, research, roadmap) are public. Gating at middleware would require maintaining an allow-list.
- **No route groups** — The flat structure keeps URLs predictable and avoids the cognitive overhead of parenthesized groups. This works well at the current route count (~21 pages) but may need revisiting if the route tree grows significantly.

---

[← Root](../README.md) · [API](api/README.md) · [Components](../components/README.md) · [Lib](../lib/README.md) · [DB](../db/README.md)
